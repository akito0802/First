<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚ˆã†ã“ãï¼ï¼</title>
  <style>
    :root{ --bg:#0b1020; --card:#151a2d; --text:#e6e8f2; --muted:#aab1c7; --accent:#7dd3fc; --bad:#ef4444; --ok:#10b981; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f1632);color:var(--text);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Noto Sans JP',sans-serif;
         min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .container{width:100%;max-width:680px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:20px;padding:18px;border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 8px;font-size:26px}
    p{margin:6px 0;color:var(--muted)}
    textarea,input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0f1430;color:var(--text)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{padding:12px 16px;border:none;border-radius:12px;cursor:pointer;color:#0b1020;font-weight:700}
    .accent{background:var(--accent)} .danger{background:#ef4444;color:#fff} .muted{background:#273053;color:#dbe2ff}
    .entry{border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;margin-top:10px;background:#0f1430}
    .meta{font-size:12px;color:#aab1c7;margin-bottom:6px}
    .empty{color:#aab1c7;font-style:italic}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="helloCard">
      <h1>ã‚ˆã†ã“ãï¼ï¼ ğŸ‰</h1>
      <p id="hello">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
      <div class="row" style="margin-top:8px">
        <button class="muted" onclick="location.href='index.html'">ãƒˆãƒƒãƒ—ã¸</button>
        <button class="danger" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">ğŸ“ ä»Šæ—¥ã®æ—¥è¨˜ã‚’æ›¸ã</h2>
      <input id="title" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆãªãã¦ã‚‚OKï¼‰" />
      <textarea id="content" rows="5" placeholder="ã“ã“ã«æ—¥è¨˜ã‚’æ›¸ãã‚ˆ"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="accent" id="saveBtn">ä¿å­˜ã™ã‚‹</button>
        <button class="muted" id="clearBtn">ã‚¯ãƒªã‚¢</button>
      </div>
      <p id="saveStatus" class="empty"></p>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">ğŸ“š ã“ã‚Œã¾ã§ã®æ—¥è¨˜</h2>
      <div id="list"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCDWW0h9y7R9yUZ1avKbJY-5xR--vlshLs",
      authDomain: "project-7889282246917454283.firebaseapp.com",
      projectId: "project-7889282246917454283",
      storageBucket: "project-7889282246917454283.firebasestorage.app",
      messagingSenderId: "239216764798",
      appId: "1:239216764798:web:da7a78c35f8686c94cb52f",
      measurementId: "G-BWHQFKFTGK"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«è©¦ã™ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ï¼‰
    db.enablePersistence().catch(function(e){});

    const hello = document.getElementById('hello');
    const logoutBtn = document.getElementById('logoutBtn');
    const titleEl = document.getElementById('title');
    const contentEl = document.getElementById('content');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const listEl = document.getElementById('list');
    const saveStatus = document.getElementById('saveStatus');

    auth.onAuthStateChanged(function(user){
      if(!user){ location.replace('index.html'); return; }
      hello.textContent = user.email + " ã•ã‚“ã€ã‚ˆã†ã“ãï¼ï¼";
      loadEntries(user.uid);
    });

    logoutBtn.onclick = async function(){
      await auth.signOut();
      location.replace('index.html');
    };

    // ä¿å­˜ï¼šcreatedAtï¼ˆã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ï¼‰ã¨ createdAtMsï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ™‚åˆ»ï¼‰ä¸¡æ–¹ä¿å­˜
    saveBtn.onclick = async function(){
      const user = auth.currentUser;
      if(!user){ return; }
      const title = titleEl.value.trim();
      const content = contentEl.value.trim();
      if(!content){ alert("æ—¥è¨˜ã®æœ¬æ–‡ã‚’æ›¸ã„ã¦ã­ï¼"); return; }

      try{
        const nowMs = Date.now();
        await db.collection('diaries').doc(user.uid).collection('entries').add({
          title: title || null,
          content: content,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAtMs: nowMs
        });
        titleEl.value = "";
        contentEl.value = "";
        saveStatus.textContent = "ä¿å­˜ã—ãŸã‚ˆï¼";
        setTimeout(()=> saveStatus.textContent = "", 1500);
      }catch(e){
        alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    };

    clearBtn.onclick = function(){ titleEl.value = ""; contentEl.value = ""; };

    // è¡¨ç¤ºã¯ createdAtMsï¼ˆæ•°å€¤ï¼‰ã§å®‰å®šã‚½ãƒ¼ãƒˆ
    function loadEntries(uid){
      listEl.innerHTML = "<p class='empty'>èª­ã¿è¾¼ã¿ä¸­â€¦</p>";
      db.collection('diaries').doc(uid).collection('entries')
        .orderBy('createdAtMs', 'desc')
        .onSnapshot(function(snap){
          if(snap.empty){
            listEl.innerHTML = "<p class='empty'>ã¾ã æ—¥è¨˜ã¯ãªã„ã‚ˆã€‚ä¸Šã§æ›¸ã„ã¦ä¿å­˜ã—ã¦ã­ï¼</p>";
            return;
          }
          listEl.innerHTML = "";
          snap.forEach(function(doc){
            const d = doc.data();
            const t = d.createdAt ? d.createdAt.toDate() : new Date(d.createdAtMs || Date.now());
            const y = t.getFullYear();
            const m = String(t.getMonth()+1).padStart(2,'0');
            const da = String(t.getDate()).padStart(2,'0');
            const hh = String(t.getHours()).padStart(2,'0');
            const mm = String(t.getMinutes()).padStart(2,'0');
            const when = y + "-" + m + "-" + da + " " + hh + ":" + mm;

            const div = document.createElement('div');
            div.className = 'entry';
            div.innerHTML =
              "<div class='meta'>" + when + (d.title ? " ï½œ " + d.title : "") + "</div>" +
              "<div>" + escapeHtml(d.content).replace(/\n/g,'<br>') + "</div>" +
              "<div class='row' style='margin-top:8px'><button class='danger' data-id='"+doc.id+"'>å‰Šé™¤</button></div>";

            div.querySelector('button').onclick = function(){
              db.collection('diaries').doc(uid).collection('entries').doc(doc.id).delete().catch(function(e){
                alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message);
              });
            };

            listEl.appendChild(div);
          });
        }, function(err){
          listEl.innerHTML = "<p class='empty'>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message + "</p>";
        });
    }

    function escapeHtml(s){
      return s.replace(/[&<>'"]/g, function(c){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]);
      });
    }
  </script>
</body>
</html>
